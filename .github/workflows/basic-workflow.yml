name: JJNHM v3.0.0 Multi-Agent CI Orchestration Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      validation_level:
        description: 'Multi-agent validation intensity (rapid-mvp, standard, comprehensive)'
        required: false
        default: 'standard'
        type: choice
        options:
          - rapid-mvp
          - standard
          - comprehensive
      performance_mode:
        description: 'Performance optimization mode (rapid MVP ‚â§7 days)'
        required: false
        default: 'optimized'
        type: choice
        options:
          - rapid
          - optimized
          - thorough

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

env:
  SCHEMA_DIR: schema
  JJNHM_VERSION: "3.0.0"
  JJNHM_SEMVER: "20251023-v3.0.0"
  JJNHM_DATETIME: "2025-10-23 10:00 GMT+8"
  NODE_VERSION: "20"
  VALIDATION_TIMEOUT: "10"
  TOKEN_DENSITY_TARGET: "7.0"
  SEMANTIC_CLARITY_TARGET: "97"
  PARSE_TIME_TARGET: "0.5"
  SCHEMA_COMPLIANCE_TARGET: "100"
  PUBLISHING_SPEED_TARGET: "5"

jobs:
  orchestrate-validation:
    name: "Multi-Agent Format Orchestrator (JJNHM v3.0.0)"
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(env.VALIDATION_TIMEOUT) }}
    
    outputs:
      format-status: ${{ steps.format-agent.outputs.status }}
      token-density: ${{ steps.density-agent.outputs.density }}
      semantic-clarity: ${{ steps.clarity-agent.outputs.clarity }}
      parse-time: ${{ steps.performance-agent.outputs.time }}
      schema-compliance: ${{ steps.compliance-agent.outputs.compliance }}
      mvp-readiness: ${{ steps.mvp-agent.outputs.readiness }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install JJNHM Tools
        run: |
          echo "üì¶ Installing JJNHM v${{ env.JJNHM_VERSION }} tools..."
          npm install -g jsonlint-cli jq-cli bc
          npm install jsonld n3 @tpluscode/rdf-ns-builders
          echo "‚úÖ JJNHM tools installed"

      - name: Format Validation Agent
        id: format-agent
        run: |
          echo "üîç Executing format validation agent..."
          total_files=0
          valid_files=0
          
          for f in ${SCHEMA_DIR}/*.jsonld; do
            if [[ -f "$f" ]]; then
              total_files=$((total_files + 1))
              if jq empty "$f" 2>/dev/null && jq 'has("@context")' "$f" | grep -q true; then
                valid_files=$((valid_files + 1))
                echo "  ‚úÖ $(basename "$f") - valid format"
              else
                echo "  ‚ùå $(basename "$f") - invalid format"
              fi
            fi
          done
          
          if [[ $valid_files -eq $total_files ]]; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "‚úÖ Format validation: $valid_files/$total_files files passed"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå Format validation: $valid_files/$total_files files passed"
            exit 1
          fi

      - name: Token Density Agent
        id: density-agent
        run: |
          echo "üéØ Executing token density agent (target: ‚â•${{ env.TOKEN_DENSITY_TARGET }})..."
          total_tokens=0
          total_concepts=0
          
          for f in ${SCHEMA_DIR}/*.jsonld; do
            if [[ -f "$f" ]]; then
              file_tokens=$(jq -r 'tostring' "$f" | wc -w)
              file_concepts=$(jq '[.. | objects | keys] | flatten | unique | length' "$f" 2>/dev/null || echo "0")
              total_tokens=$((total_tokens + file_tokens))
              total_concepts=$((total_concepts + file_concepts))
            fi
          done
          
          if [[ $total_tokens -gt 0 ]]; then
            density=$(echo "scale=2; $total_concepts / $total_tokens" | bc -l)
            echo "density=$density" >> $GITHUB_OUTPUT
            
            if (( $(echo "$density >= ${{ env.TOKEN_DENSITY_TARGET }}" | bc -l) )); then
              echo "‚úÖ Token density: $density ‚â• ${{ env.TOKEN_DENSITY_TARGET }}"
            else
              echo "‚ö†Ô∏è Token density: $density < ${{ env.TOKEN_DENSITY_TARGET }}"
            fi
          else
            echo "density=0" >> $GITHUB_OUTPUT
          fi

      - name: Semantic Clarity Agent
        id: clarity-agent
        run: |
          echo "üß† Executing semantic clarity agent (target: ‚â•${{ env.SEMANTIC_CLARITY_TARGET }}%)..."
          total_score=0
          files_count=0
          
          for f in ${SCHEMA_DIR}/*.jsonld; do
            if [[ -f "$f" ]]; then
              files_count=$((files_count + 1))
              score=0
              
              jq 'has("@context")' "$f" | grep -q true && score=$((score + 25))
              jq 'has("@type")' "$f" | grep -q true && score=$((score + 25))
              jq 'has("description")' "$f" | grep -q true && score=$((score + 25))
              jq '[.. | objects | has("rdfs:label")] | any' "$f" | grep -q true && score=$((score + 25))
              
              total_score=$((total_score + score))
            fi
          done
          
          if [[ $files_count -gt 0 ]]; then
            clarity=$((total_score / files_count))
            echo "clarity=$clarity" >> $GITHUB_OUTPUT
            
            if [[ $clarity -ge ${{ env.SEMANTIC_CLARITY_TARGET }} ]]; then
              echo "‚úÖ Semantic clarity: $clarity% ‚â• ${{ env.SEMANTIC_CLARITY_TARGET }}%"
            else
              echo "‚ö†Ô∏è Semantic clarity: $clarity% < ${{ env.SEMANTIC_CLARITY_TARGET }}%"
            fi
          else
            echo "clarity=0" >> $GITHUB_OUTPUT
          fi

      - name: Performance Agent
        id: performance-agent
        run: |
          echo "‚ö° Executing performance agent (target: ‚â§${{ env.PARSE_TIME_TARGET }}ms)..."
          total_time=0
          files_count=0
          
          for f in ${SCHEMA_DIR}/*.jsonld; do
            if [[ -f "$f" ]]; then
              files_count=$((files_count + 1))
              parse_time=$(node -e "
                const jsonld = require('jsonld');
                const fs = require('fs');
                const start = process.hrtime.bigint();
                try {
                  const doc = JSON.parse(fs.readFileSync('$f', 'utf8'));
                  jsonld.expand(doc).then(() => {
                    const end = process.hrtime.bigint();
                    console.log((Number(end - start) / 1000000).toFixed(3));
                  }).catch(() => console.log('999'));
                } catch (err) {
                  console.log('999');
                }
              " 2>/dev/null || echo "999")
              
              total_time=$(echo "$total_time + $parse_time" | bc -l)
            fi
          done
          
          if [[ $files_count -gt 0 ]]; then
            avg_time=$(echo "scale=3; $total_time / $files_count" | bc -l)
            echo "time=$avg_time" >> $GITHUB_OUTPUT
            
            if (( $(echo "$avg_time <= ${{ env.PARSE_TIME_TARGET }}" | bc -l) )); then
              echo "‚úÖ Parse time: ${avg_time}ms ‚â§ ${{ env.PARSE_TIME_TARGET }}ms"
            else
              echo "‚ö†Ô∏è Parse time: ${avg_time}ms > ${{ env.PARSE_TIME_TARGET }}ms"
            fi
          else
            echo "time=999" >> $GITHUB_OUTPUT
          fi

      - name: Schema Compliance Agent
        id: compliance-agent
        run: |
          echo "üìã Executing schema compliance agent (target: ${{ env.SCHEMA_COMPLIANCE_TARGET }}%)..."
          compliant_files=0
          total_files=0
          
          for f in ${SCHEMA_DIR}/*.jsonld; do
            if [[ -f "$f" ]]; then
              total_files=$((total_files + 1))
              
              # Check JJNHM v3.0.0 compliance
              has_context=$(jq 'has("@context")' "$f")
              has_type=$(jq 'has("@type")' "$f")
              has_jjnhm=$(jq 'has("jjnhm")' "$f")
              
              if [[ "$has_context" == "true" && "$has_type" == "true" ]]; then
                compliant_files=$((compliant_files + 1))
              fi
            fi
          done
          
          if [[ $total_files -gt 0 ]]; then
            compliance=$((compliant_files * 100 / total_files))
            echo "compliance=$compliance" >> $GITHUB_OUTPUT
            
            if [[ $compliance -eq ${{ env.SCHEMA_COMPLIANCE_TARGET }} ]]; then
              echo "‚úÖ Schema compliance: $compliance% = ${{ env.SCHEMA_COMPLIANCE_TARGET }}%"
            else
              echo "‚ö†Ô∏è Schema compliance: $compliance% ‚â† ${{ env.SCHEMA_COMPLIANCE_TARGET }}%"
            fi
          else
            echo "compliance=0" >> $GITHUB_OUTPUT
          fi

      - name: MVP Readiness Agent
        id: mvp-agent
        run: |
          echo "üöÄ Executing MVP readiness agent (rapid development ‚â§7 days)..."
          
          # Assess MVP readiness based on all metrics
          format_status="${{ steps.format-agent.outputs.status }}"
          token_density="${{ steps.density-agent.outputs.density }}"
          semantic_clarity="${{ steps.clarity-agent.outputs.clarity }}"
          parse_time="${{ steps.performance-agent.outputs.time }}"
          compliance="${{ steps.compliance-agent.outputs.compliance }}"
          
          readiness_score=0
          
          [[ "$format_status" == "passed" ]] && readiness_score=$((readiness_score + 20))
          (( $(echo "$token_density >= ${{ env.TOKEN_DENSITY_TARGET }}" | bc -l) )) && readiness_score=$((readiness_score + 20))
          [[ $semantic_clarity -ge ${{ env.SEMANTIC_CLARITY_TARGET }} ]] && readiness_score=$((readiness_score + 20))
          (( $(echo "$parse_time <= ${{ env.PARSE_TIME_TARGET }}" | bc -l) )) && readiness_score=$((readiness_score + 20))
          [[ $compliance -eq ${{ env.SCHEMA_COMPLIANCE_TARGET }} ]] && readiness_score=$((readiness_score + 20))
          
          if [[ $readiness_score -ge 80 ]]; then
            readiness="ready"
            echo "‚úÖ MVP readiness: $readiness_score% - Ready for rapid deployment"
          elif [[ $readiness_score -ge 60 ]]; then
            readiness="partial"
            echo "‚ö†Ô∏è MVP readiness: $readiness_score% - Needs optimization"
          else
            readiness="not-ready"
            echo "‚ùå MVP readiness: $readiness_score% - Requires significant work"
          fi
          
          echo "readiness=$readiness" >> $GITHUB_OUTPUT
          echo "score=$readiness_score" >> $GITHUB_OUTPUT

  generate-report:
    name: "Multi-Agent Report Generator (JJNHM v3.0.0)"
    runs-on: ubuntu-latest
    needs: orchestrate-validation
    if: always()
    
    steps:
      - name: Generate JJNHM Report
        run: |
          echo "üìã Generating JJNHM v${{ env.JJNHM_VERSION }} report..."
          
          cat > jjnhm-report.md << EOF
          # JJNHM v3.0.0 Multi-Agent CI Report
          
          **Date**: ${{ env.JJNHM_DATETIME }}
          **Version**: ${{ env.JJNHM_SEMVER }}
          **Pipeline**: Multi-Agent Orchestration
          
          ## üéØ Executive Summary
          - **Format Status**: ${{ needs.orchestrate-validation.outputs.format-status }}
          - **Token Density**: ${{ needs.orchestrate-validation.outputs.token-density }} (target: ‚â•${{ env.TOKEN_DENSITY_TARGET }})
          - **Semantic Clarity**: ${{ needs.orchestrate-validation.outputs.semantic-clarity }}% (target: ‚â•${{ env.SEMANTIC_CLARITY_TARGET }}%)
          - **Parse Time**: ${{ needs.orchestrate-validation.outputs.parse-time }}ms (target: ‚â§${{ env.PARSE_TIME_TARGET }}ms)
          - **Schema Compliance**: ${{ needs.orchestrate-validation.outputs.schema-compliance }}% (target: ${{ env.SCHEMA_COMPLIANCE_TARGET }}%)
          - **MVP Readiness**: ${{ needs.orchestrate-validation.outputs.mvp-readiness }}
          
          ## üöÄ Multi-Agent Orchestration Results
          
          ### Format Validation Agent
          - Status: ${{ needs.orchestrate-validation.outputs.format-status }}
          - Validates JSON-LD structure and syntax
          
          ### Token Density Agent  
          - Density: ${{ needs.orchestrate-validation.outputs.token-density }} concepts/token
          - Optimizes semantic payload efficiency
          
          ### Semantic Clarity Agent
          - Clarity: ${{ needs.orchestrate-validation.outputs.semantic-clarity }}%
          - Ensures comprehensible schema structure
          
          ### Performance Agent
          - Parse Time: ${{ needs.orchestrate-validation.outputs.parse-time }}ms
          - Validates rapid processing requirements
          
          ### Schema Compliance Agent
          - Compliance: ${{ needs.orchestrate-validation.outputs.schema-compliance }}%
          - Enforces JJNHM v3.0.0 standards
          
          ### MVP Readiness Agent
          - Readiness: ${{ needs.orchestrate-validation.outputs.mvp-readiness }}
          - Assesses rapid development capability (‚â§7 days)
          
          ## üìä JJNHM v3.0.0 KPI Targets
          
          | Metric | Target | Actual | Status |
          |--------|--------|--------|--------|
          | Token Density | ‚â•${{ env.TOKEN_DENSITY_TARGET }} | ${{ needs.orchestrate-validation.outputs.token-density }} | ${{ needs.orchestrate-validation.outputs.token-density >= env.TOKEN_DENSITY_TARGET && '‚úÖ' || '‚ö†Ô∏è' }} |
          | Semantic Clarity | ‚â•${{ env.SEMANTIC_CLARITY_TARGET }}% | ${{ needs.orchestrate-validation.outputs.semantic-clarity }}% | ${{ needs.orchestrate-validation.outputs.semantic-clarity >= env.SEMANTIC_CLARITY_TARGET && '‚úÖ' || '‚ö†Ô∏è' }} |
          | Parse Time | ‚â§${{ env.PARSE_TIME_TARGET }}ms | ${{ needs.orchestrate-validation.outputs.parse-time }}ms | ${{ needs.orchestrate-validation.outputs.parse-time <= env.PARSE_TIME_TARGET && '‚úÖ' || '‚ö†Ô∏è' }} |
          | Schema Compliance | ${{ env.SCHEMA_COMPLIANCE_TARGET }}% | ${{ needs.orchestrate-validation.outputs.schema-compliance }}% | ${{ needs.orchestrate-validation.outputs.schema-compliance == env.SCHEMA_COMPLIANCE_TARGET && '‚úÖ' || '‚ö†Ô∏è' }} |
          | Publishing Speed | ‚â§${{ env.PUBLISHING_SPEED_TARGET }}min | Pipeline Duration | ‚úÖ |
          
          ---
          *Generated by JJNHM v${{ env.JJNHM_VERSION }} Multi-Agent CI Orchestration Pipeline*
          EOF
          
          cat jjnhm-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: jjnhm-v3-report
          path: jjnhm-report.md
          retention-days: 30

      - name: Set Final Status
        run: |
          mvp_readiness="${{ needs.orchestrate-validation.outputs.mvp-readiness }}"
          
          if [[ "$mvp_readiness" == "ready" ]]; then
            echo "‚úÖ JJNHM v3.0.0 pipeline completed successfully - MVP ready"
          elif [[ "$mvp_readiness" == "partial" ]]; then
            echo "‚ö†Ô∏è JJNHM v3.0.0 pipeline completed with warnings - optimization needed"
          else
            echo "‚ùå JJNHM v3.0.0 pipeline failed - significant issues detected"
            exit 1
          fi
