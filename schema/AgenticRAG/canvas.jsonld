{
  "@context": "https://huijoohwee.github.io/schema/AgenticRAG/v1/context.jsonld",
  "@id": "rag:Canvas",
  "@type": "rag:Directive",
  "schemaVersion": "1.0.0",
  "rdfs:label": [
    { "@value": "Canvas integration directives", "@language": "en-us" },
    { "@value": "画布集成指令", "@language": "zh-cn" }
  ],
  "rdfs:comment": [
    {
      "@value": "Directive describing domain-agnostic integration contracts for Canvas render surfaces that consume AgenticRAG JSON-LD graphs. Focuses on order-safe import→render behavior, cache-key isolation, renderer exclusivity, and viewport-aware auto-fit so different renderers (2D/3D/Flow/Geospatial) do not drift or contaminate each other at runtime.",
      "@language": "en-us"
    },
    {
      "@value": "描述消费 AgenticRAG JSON-LD 图的 Canvas 渲染表面的领域无关集成契约。重点覆盖顺序安全的 import→render 行为、缓存 key 隔离、渲染器互斥，以及对 viewport 变化敏感的自适配（auto-fit），避免 2D/3D/Flow/Geospatial 等渲染器在运行时发生漂移或相互污染。",
      "@language": "zh-cn"
    }
  ],
  "canvasContracts": {
    "rendererExclusivity": [
      {
        "@value": "Only one renderer surface is mounted at a time (D3 2D, Flow 2D, 3D, Geospatial). Non-active surfaces must not subscribe to graph store updates, run layouts, or mutate shared caches. Switching renderer surfaces must preserve selection and view state via a stable SSOT view key rather than duplicating computation.",
        "@language": "en-us"
      },
      {
        "@value": "任意时刻只允许挂载一个渲染表面（D3 2D、Flow 2D、3D、Geospatial）。非激活表面不得订阅图状态更新、运行布局、或写入共享缓存。切换渲染表面必须通过稳定的 SSOT view key 保持选择与视图状态，而不是重复计算。",
        "@language": "zh-cn"
      }
    ],
    "viewKeyIsolation": [
      {
        "@value": "View state and caches are isolated by a viewKey that includes all render-affecting toggles (render mode, renderer variant, semantic/frontmatter mode, group collapse, media density, and other presentation settings). Avoid cross-mode contamination by never sharing zoom/layout caches between different view keys.",
        "@language": "en-us"
      },
      {
        "@value": "视图状态与缓存必须按 viewKey 隔离，viewKey 需要包含所有影响渲染的开关（渲染模式、渲染器变体、semantic/frontmatter 模式、group collapse、媒体密度与其他展示设置）。不同 viewKey 之间禁止共享 zoom/layout 缓存，以避免跨模式污染。",
        "@language": "zh-cn"
      }
    ],
    "layoutCacheKeyIsolation": [
      {
        "@value": "Layout caches (positions, seeds, bounding boxes) must include all layout-affecting inputs in their cache keys, including renderer variant and media-related toggles. When a renderer variant changes, the layout pipeline must treat it as a distinct variant and avoid reusing stale positioning from another renderer.",
        "@language": "en-us"
      },
      {
        "@value": "布局缓存（位置、seed、包围盒）必须在 cache key 中纳入所有影响布局的输入，包括渲染器变体与媒体相关开关。渲染器变体变化时，布局流水线必须视其为不同变体，禁止复用来自其他渲染器的过期定位结果。",
        "@language": "zh-cn"
      }
    ],
    "viewportAwareAutoFit": [
      {
        "@value": "Auto-fit/fit-to-screen must react to viewport dimension changes (including UI chrome changes such as sidebar/panel toggles). Auto-fit should be idempotent and should not fight user pinning; when view is pinned, auto-fit is suppressed until explicitly re-enabled.",
        "@language": "en-us"
      },
      {
        "@value": "自适配/铺满屏幕必须对 viewport 尺寸变化作出响应（包括侧边栏/面板开关等 UI chrome 变化）。自适配应幂等，且不得与用户的 pin 操作对抗；当视图被 pin 时，自适配应被抑制，直到用户显式重新启用。",
        "@language": "zh-cn"
      }
    ],
    "collisionNoStick": [
      {
        "@value": "Collision resolution must forbid exact-contact sticking: treat near-touch as overlap via a small touch-epsilon and enforce axis-aware spacing using sum-of-gaps (gapA + gapB) rather than max. Model boxes with indexed borders (inner x2..x4/y2..y4/z2..z4 vs outer envelope x1..x5/y1..y5/z1..z5); nested containment must compare child inner to parent outer. Z-axis resolution must be explicitly gated (non-zero cz, positive halfD, or positive explicit gapZ); otherwise treat Z as infinite overlap so 2D surfaces never accidentally push in Z.",
        "@language": "en-us"
      },
      {
        "@value": "碰撞消解必须禁止“贴边粘连”：通过 touch-epsilon 将近似接触视为重叠，并使用按轴间距的 sum-of-gaps（gapA + gapB）而不是 max 来保证更严格的分离。将盒子建模为带索引的边界（内边界 x2..x4/y2..y4/z2..z4 vs 外包络 x1..x5/y1..y5/z1..z5），嵌套包裹需对比子盒内边界与父盒外包络。Z 轴消解必须显式 gating（cz 非零、halfD 为正、或显式 gapZ 为正）；否则将 Z 视为无限重叠，确保 2D 表面不会误在 Z 轴上推挤。",
        "@language": "zh-cn"
      }
    ],
    "orderSafeImportRender": [
      {
        "@value": "Import→render flows are order-safe and batch-aware: bulk imports coalesce change notifications; late async completions (layouts, previews, derived views) must not override the currently selected graph or viewKey. Prefer explicit request ids or monotonic revision counters for applying async results.",
        "@language": "en-us"
      },
      {
        "@value": "Import→render 流程必须具备顺序安全与批处理意识：批量导入要合并变更通知；异步任务（布局、预览、派生视图）的迟到完成不得覆盖当前选择的图或 viewKey。应优先使用显式 request id 或单调递增的 revision 计数来应用异步结果。",
        "@language": "zh-cn"
      }
    ],
    "ssotActiveGraphRenderView": [
      {
        "@value": "All render surfaces consume the same SSOT-derived active graph render view. Derivation order: keyword base → optional frontmatter filter (document mode only) → optional group collapse. Forbid per-surface re-derivation to prevent drift between Canvas, Flow overview, tables, and stats panels.",
        "@language": "en-us"
      },
      {
        "@value": "所有渲染表面必须消费同一份 SSOT 推导的 active graph render view。推导顺序：keyword 基础图 → 可选 frontmatter 过滤（仅 document mode）→ 可选 group collapse。禁止各表面自行二次推导，避免 Canvas、Flow 概览、表格与统计面板之间产生漂移。",
        "@language": "zh-cn"
      }
    ],
    "documentStructureBaselineDefault": [
      {
        "@value": "Default UX anchors to Document Structure baseline. A persisted baseline lock may disable mode switches (semantic/frontmatter, renderer, 2D/3D, selection/create) to keep Editor/Table/Canvas/Preview content-aligned and prevent cross-surface drift.",
        "@language": "en-us"
      },
      {
        "@value": "默认体验锚定在 Document Structure 基线。可通过持久化的 baseline lock 禁用模式切换（semantic/frontmatter、渲染器、2D/3D、选择/创建），以确保 Editor/Table/Canvas/Preview 内容对齐并防止跨表面漂移。",
        "@language": "zh-cn"
      }
    ]
  }
}
